## 14-11-你们的TPS的指标是什么估算的-

假设一个系统的业务有登录、浏览帖子、发送新帖、回复帖子，访问高峰是上午10点，日访问高峰PV约5208(含登录1300、浏览2706、发帖526、回帖676)，系统响应时间要求小于3秒，试计算此系统的TPS以及并发数。

如果分析业务量的数据是以PV来统计的，我们需要把PV转化为TPS。

PV的统计一般可以通过监控埋点或者统计访问日志统计得出。

说到PV还有个特殊的情况，叫 PeakY，指一天中PV数达到的高峰PV值。

通过一些监控系统，也可以直观看到统计数据。

实际上一个PV即一次对服务器的客户请求，可能还包含了很多资源请求，比如图片、样式JS信息、文字等。而浏览器具有资源缓存功能，下次访问同样资源将不会再从远程服务器上下载，这大大加快了响应速度。如果我们使用代理服务器访问外网资源时，多数代理服务器也会缓存这些静态数据。也就是说浏览器与服务器之间的动态数据的Size会小于静态数据。

所以浏览器是否缓存了静态数据对性能测试影响明显。我们在做性能测试时，其中就有许多用户可能是新用户，在他们的浏览器上还没有缓存这些静态数据，为了更准确的模拟用户请求，我们有必要不缓存这些静态内容.所以性能测试中是否缓存访问的静态资源要根据业务情况而定。

本例中，我们把一个请求放在一个事务中来统计服务器的响应时间。这么说，一个PV即是一个事务(每秒的PV量并不直接等同于TPS，因为一次客户请求可能包含了很多资源请求。如果我们不关心页面刷新时请求资源的耗时，此时我们就把每秒PV数等同于TPS)，比如一个功能页面(浏览帖子)每秒会有10个PV，那么此功能的TPS即为10。

**估算TPS：**

业务量一般要取系统业务高峰的值，才能代表系统的实际处理能力，系统在10点的访问高峰PV约5208，那么这个时段的TPS = 5208/3600 ≈ 1.45吗?

答案是否定的，因为在一小时内的吞吐量未必是平均的。

如果我们采集到的业务量数据能够细分到每分钟，TPS就越准确。如果不能，可以按照二八原则。即80%的业务在20%的时间内完成，TPS=(5208*80%)/(3600*20%)≈5.8

**估算并发数：**

1、由TPS进行估算  2、由在线活动用户数估算   3、根据经验估算

方法1：由TPS进行估算

因为TPS=事务数/时间，假设所有的事务都来自不同的用户，那么并发数=事务数=TPS * 时间。

具体如下：

Vu(业务名称)=TPS(业务名称)*( Runtime+ ThinkTime)

其中，Vu(业务名称)表示此业务的虚拟用户数，即并发数。 RunTime是测试程序/脚本运行一次所消耗的时间，包括事务时间+非事务时间。 ThinkTime是模拟用户思考或者填写表单消耗的时间。

下面是发帖动作的测试脚本伪代码(T、TT、AT表示时间，单位为秒，AT一般都是非常小的，包含在事务时间中，可以忽略).Runtime=T1+...+T7; ThinkTime=TT1+TT2。

Login

Enter login page (进入登录页面)Tl=0.2

ThinkTime (思考时间)TT1=3

Declare login trans action (声明登录事务)T2=3

Commat formm (提交登录表单)

Assertlogin (检资登录是否成功)AT1

Enter default page(进入登录成功后的默认页)T3=0.2

Sender topic

Enter topic list (进入论坛列表)T4=0.2

Enter new page for topic (选入新帖编辑页面)T5=0.2

ThinkTime (思考时间)TT2=3

Declare newTopic transaction (声明新帖事务)T6=3

Commit fom (提交新帖)

Assert commit (查发帖是否成功)AT2

Enter topic list (提交新帖后进入论坛列表)T7=0.2

业内一般把 Think Time设为3秒。测试需求中要求响应时间小于3秒，我们就以3秒为阀值

可得 Vu=TPS (RunTime + ThinkTime)=5.8*(T1+TT1+T2+T3+T4+T5+TT2+T6+T7)≈76

如果只计算事务时间，Vu=TPS*(T2+T3)=34.8≈35

可以看到两者之间的Vu数量相差巨大。由于一次迭代的时间会大于事务的响应时间，如果在估算时不把非事务消耗的时间加入进去，计算出来的12个并发用户在测试执行时很有可能无法达到TPS=5.8的目标。

由于我们计算Vu时，使用的是系统TPS(登录、浏览、发帖、回帖合计)，其中又以发帖业务消耗时间最长，所以计算出来的76个并发数实际上是系统业务的总并发数，需要按比例分配到各个业务。

| 业务名称 | 高峰业务量 | TPS  | 并发数 | 响应时间 | 事务成功率 |
| -------- | ---------- | ---- | ------ | -------- | ---------- |
| 登录     | 1300       | 1.44 | 20     | <3秒     | >99%       |
| 浏览     | 2706       | 3.0  | 40     | <3秒     | >99%       |
| 发帖     | 526        | 0.58 | 7      | <3秒     | >99%       |
| 回帖     | 676        | 0.75 | 10     | <3秒     | >99%       |
| 合计     | 5208       | 5.8  | 77     | -        | -          |



方法2：在线活动用户数估算

1. 在线用户数的预估可以采取20%的系统用户数.例如某个系统的系统用户数有1000，则同时在线用户数据有可能达到200，或者预估200做参考。

在线用户数和并发用户数又存在着关系，即：平均并发用户数为C=NLTL为在线时长，T为考核时长例如考核时长为1天，即8小时，但是用户平均在线时长为2小时，则c=n*2/8

n为登录系统的用户数，L为登录的时常。例如一个系统有400个用户登录，然后每个用户登录大概停留2小时，则以一天8小时考核，算平均并发用户则为C=400*2/8

答：我们系统的TPS当时是根据PV值来计算的，就是通过查看系统访问日志来获取每个业务功能每天高峰期的PV值(也就是每天高峰期的时间段，有多少服务器的客户请求)，

当时的PV值大概在5000多

然后按照二八原则，即80%的业务在20%的时间内完成，TPS=(P80%)/(时间20%)≈5.6。算出来大概在5.6。

[具体的指标都是SE跟测试主管他们经过分析出来给到我们的。他们开会的时候大概跟我们说过估算方式，差不多是这样的……]
